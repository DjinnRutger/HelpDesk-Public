{% extends 'base.html' %}
{% block title %}{{ category.name }} Â· Documents{% endblock %}
{% block content %}
<!-- Category Header -->
<div class="card shadow-sm mb-3">
  <div class="card-header bg-body-tertiary">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="d-flex align-items-center">
        <i class="bi bi-folder2-open text-primary me-2 fs-4"></i>
        <div>
          <h1 class="h5 mb-0">{{ category.name }}</h1>
          <small class="text-muted">Document category</small>
        </div>
      </div>
      <div class="d-flex gap-2">
        <a href="{{ url_for('documents.index') }}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-arrow-left me-1"></i>All Categories
        </a>
        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newDocumentModal">
          <i class="bi bi-plus-lg me-1"></i>New Document
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Search Bar -->
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="get" action="{{ url_for('documents.search') }}" class="row g-2">
      <div class="col-12 col-md-10">
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="text" name="q" class="form-control" placeholder="Search all documents by name or content..." 
                 value="">
        </div>
      </div>
      <div class="col-12 col-md-2">
        <button type="submit" class="btn btn-primary w-100">
          <i class="bi bi-search me-1"></i>Search
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Documents List -->
<div class="card shadow-sm">
  <div class="card-header bg-body-tertiary">
    <div class="d-flex align-items-center justify-content-between">
      <h6 class="mb-0"><i class="bi bi-file-earmark-text me-1"></i>Documents</h6>
      {% if documents %}
      <span class="text-muted small">{{ documents|length }} document{{ 's' if documents|length != 1 else '' }}</span>
      {% endif %}
    </div>
  </div>
  <div class="card-body p-0">
    {% if documents %}
      <div class="list-group list-group-flush">
        {% for d in documents %}
        <a href="{{ url_for('documents.view', doc_id=d.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <i class="bi bi-file-earmark-text me-2 text-primary"></i>
            <span class="fw-semibold">{{ d.name }}</span>
          </div>
          <div class="text-muted small d-flex align-items-center">
            <i class="bi bi-clock me-1"></i>
            Updated {{ d.updated_at|cst_datetime }}
          </div>
        </a>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-5">
        <i class="bi bi-file-earmark-text display-1 text-muted opacity-25"></i>
        <h5 class="mt-3 mb-2">No Documents Found</h5>
        <p class="text-muted mb-3">This category doesn't have any documents yet.</p>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newDocumentModal">
          <i class="bi bi-plus-lg me-1"></i>Create First Document
        </button>
      </div>
    {% endif %}
  </div>
</div>

<!-- New Document Modal -->
<div class="modal fade" id="newDocumentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">New Document</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="newDocForm" method="post" action="{{ url_for('documents.new_document', category_id=category.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="mb-2">
            <label class="form-label">Name</label>
            <input name="name" id="docNameInput" class="form-control" placeholder="Document name" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Body</label>
            <div class="btn-toolbar mb-2" role="toolbar" aria-label="Editor toolbar">
              <div class="btn-group btn-group-sm me-1" role="group">
                <button type="button" class="btn btn-outline-secondary" data-cmd="bold" title="Bold"><i class="bi bi-type-bold"></i></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="italic" title="Italic"><i class="bi bi-type-italic"></i></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="underline" title="Underline"><i class="bi bi-type-underline"></i></button>
              </div>
              <div class="btn-group btn-group-sm me-1" role="group">
                <button type="button" class="btn btn-outline-secondary" data-cmd="insertUnorderedList" title="Bulleted list"><i class="bi bi-list-ul"></i></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="insertOrderedList" title="Numbered list"><i class="bi bi-list-ol"></i></button>
              </div>
              <div class="btn-group btn-group-sm me-1" role="group">
                <button type="button" class="btn btn-outline-secondary" data-cmd="formatBlock" data-value="h3" title="Heading">H3</button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="formatBlock" data-value="p" title="Paragraph">P</button>
              </div>
              <div class="btn-group btn-group-sm me-1" role="group">
                <button type="button" class="btn btn-outline-secondary" id="linkBtn" title="Insert link"><i class="bi bi-link-45deg"></i></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="removeFormat" title="Clear formatting"><i class="bi bi-eraser"></i></button>
              </div>
              <div class="btn-group btn-group-sm" role="group" aria-label="Table tools">
                <button type="button" class="btn btn-outline-secondary" id="tblInsert" title="Insert 3x3 table"><i class="bi bi-table"></i></button>
                <button type="button" class="btn btn-outline-secondary" id="tblAddRow" title="Add row below"><i class="bi bi-plus-lg"></i> Row</button>
                <button type="button" class="btn btn-outline-secondary" id="tblAddCol" title="Add column right"><i class="bi bi-plus-lg"></i> Col</button>
                <button type="button" class="btn btn-outline-secondary" id="tblDelRow" title="Delete row"><i class="bi bi-x-lg"></i> Row</button>
                <button type="button" class="btn btn-outline-secondary" id="tblDelCol" title="Delete column"><i class="bi bi-x-lg"></i> Col</button>
                <button type="button" class="btn btn-outline-secondary" id="tblDelTable" title="Delete table"><i class="bi bi-trash"></i></button>
              </div>
            </div>
            <div id="editorBody" class="form-control" contenteditable="true" style="min-height: 240px;"></div>
            <textarea name="body" id="hiddenBody" class="d-none"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitNewDoc">Create</button>
      </div>
    </div>
  </div>
 </div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const toolbar = document.querySelector('#newDocumentModal .btn-toolbar');
    const editor = document.getElementById('editorBody');
    const hidden = document.getElementById('hiddenBody');
    const form = document.getElementById('newDocForm');
    const submitBtn = document.getElementById('submitNewDoc');
    const linkBtn = document.getElementById('linkBtn');
  // Table buttons
  const btnIns = document.getElementById('tblInsert');
  const btnAddRow = document.getElementById('tblAddRow');
  const btnAddCol = document.getElementById('tblAddCol');
  const btnDelRow = document.getElementById('tblDelRow');
  const btnDelCol = document.getElementById('tblDelCol');
  const btnDelTable = document.getElementById('tblDelTable');

    if (toolbar) {
      toolbar.addEventListener('click', function(e) {
        const btn = e.target.closest('button[data-cmd]');
        if (!btn) return;
        const cmd = btn.getAttribute('data-cmd');
        const val = btn.getAttribute('data-value');
        if (cmd === 'formatBlock') {
          document.execCommand(cmd, false, val || 'p');
        } else {
          document.execCommand(cmd, false, null);
        }
        editor.focus();
      });
    }
    if (linkBtn) {
      linkBtn.addEventListener('click', function() {
        let url = prompt('Enter URL (include http(s)://)');
        if (!url) return;
        try {
          if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
        } catch(e) {}
        document.execCommand('createLink', false, url);
        // Ensure new link opens in new tab
        const sel = window.getSelection();
        if (sel && sel.anchorNode) {
          let node = sel.anchorNode.nodeType === 3 ? sel.anchorNode.parentElement : sel.anchorNode;
          while (node && node !== editor && node.tagName !== 'A') node = node.parentElement;
          if (node && node.tagName === 'A') {
            node.setAttribute('target','_blank');
            node.setAttribute('rel','noopener noreferrer');
          }
        }
        editor.focus();
      });
    }
    if (submitBtn && form && editor && hidden) {
      submitBtn.addEventListener('click', function() {
        hidden.value = editor.innerHTML;
        form.submit();
      });
    }
    const modalEl = document.getElementById('newDocumentModal');
    if (modalEl) {
      modalEl.addEventListener('shown.bs.modal', function() {
        const nameEl = document.getElementById('docNameInput');
        if (nameEl) nameEl.focus();
      });
    }
    // Helpers for table editing
    function closest(el, selector) {
      while (el && el.nodeType === 1) {
        if (el.matches(selector)) return el;
        el = el.parentElement;
      }
      return null;
    }
    function getSelectedCell() {
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return null;
      let node = sel.anchorNode;
      if (node && node.nodeType === 3) node = node.parentElement;
      return node ? closest(node, 'td,th') : null;
    }
    function insertTable(rows=3, cols=3) {
      let html = '<table class="table table-bordered table-sm"><tbody>';
      for (let r=0;r<rows;r++) {
        html += '<tr>';
        for (let c=0;c<cols;c++) html += '<td>&nbsp;</td>';
        html += '</tr>';
      }
      html += '</tbody></table>';
      document.execCommand('insertHTML', false, html);
      editor.focus();
    }
    function addRowBelow() {
      const cell = getSelectedCell();
      if (!cell) return;
      const tr = closest(cell, 'tr');
      const cols = tr ? tr.children.length : 0;
      const newTr = document.createElement('tr');
      for (let i=0;i<cols;i++) {
        const td = document.createElement('td');
        td.innerHTML = '&nbsp;';
        newTr.appendChild(td);
      }
      tr.parentElement.insertBefore(newTr, tr.nextSibling);
    }
    function addColRight() {
      const cell = getSelectedCell();
      if (!cell) return;
      const index = Array.from(cell.parentElement.children).indexOf(cell);
      const table = closest(cell, 'table');
      if (!table) return;
      table.querySelectorAll('tr').forEach(tr => {
        const td = document.createElement('td');
        td.innerHTML = '&nbsp;';
        if (index >= 0 && index < tr.children.length-1) {
          tr.insertBefore(td, tr.children[index+1]);
        } else {
          tr.appendChild(td);
        }
      });
    }
    function delRow() {
      const cell = getSelectedCell();
      if (!cell) return;
      const tr = closest(cell, 'tr');
      if (tr) tr.remove();
    }
    function delCol() {
      const cell = getSelectedCell();
      if (!cell) return;
      const index = Array.from(cell.parentElement.children).indexOf(cell);
      const table = closest(cell, 'table');
      if (!table) return;
      table.querySelectorAll('tr').forEach(tr => {
        if (index >=0 && index < tr.children.length) tr.children[index].remove();
      });
    }
    function delTable() {
      const cell = getSelectedCell();
      if (!cell) return;
      const table = closest(cell, 'table');
      if (table) table.remove();
    }
    if (btnIns) btnIns.addEventListener('click', () => insertTable());
    if (btnAddRow) btnAddRow.addEventListener('click', () => addRowBelow());
    if (btnAddCol) btnAddCol.addEventListener('click', () => addColRight());
    if (btnDelRow) btnDelRow.addEventListener('click', () => delRow());
    if (btnDelCol) btnDelCol.addEventListener('click', () => delCol());
    if (btnDelTable) btnDelTable.addEventListener('click', () => delTable());
  });
</script>
{% endblock %}

{% extends 'base.html' %}
{% block title %}{{ doc.name }} Â· Documents{% endblock %}
{% block content %}
<!-- Document Header -->
<div class="card shadow-sm mb-3">
  <div class="card-header bg-body-tertiary">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="d-flex align-items-center">
        <i class="bi bi-file-earmark-text text-primary me-2 fs-4"></i>
        <div>
          <h1 class="h5 mb-0">{{ doc.name }}</h1>
          <small class="text-muted">
            <i class="bi bi-folder me-1"></i>{{ category.name }}
          </small>
        </div>
      </div>
      <div class="d-flex gap-2">
        <a href="{{ url_for('documents.category', category_id=category.id) }}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-arrow-left me-1"></i>Back to {{ category.name }}
        </a>
        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editDocModal">
          <i class="bi bi-pencil me-1"></i>Edit
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Document Content -->
<div class="card shadow-sm">
  <div class="card-body">
    <div class="document-content">
      {{ doc.body|safe }}
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Edit Document Modal -->
<div class="modal fade" id="editDocModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Document</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editDocForm" method="post" action="{{ url_for('documents.edit', doc_id=doc.id) }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="mb-2">
            <label class="form-label">Category</label>
            <select name="category_id" class="form-select">
              {% for c in categories %}
                <option value="{{ c.id }}" {% if c.id == doc.category_id %}selected{% endif %}>{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Name</label>
            <input name="name" id="editDocName" class="form-control" value="{{ doc.name }}" required>
          </div>
          <div class="mb-2">
            <label class="form-label">Body</label>
            <div class="btn-toolbar mb-2" role="toolbar" aria-label="Editor toolbar">
              <div class="btn-group btn-group-sm me-1" role="group">
                <button type="button" class="btn btn-outline-secondary" data-cmd="bold" title="Bold"><i class="bi bi-type-bold"></i></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="italic" title="Italic"><i class="bi bi-type-italic"></i></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="underline" title="Underline"><i class="bi bi-type-underline"></i></button>
              </div>
              <div class="btn-group btn-group-sm me-1" role="group">
                <button type="button" class="btn btn-outline-secondary" data-cmd="insertUnorderedList" title="Bulleted list"><i class="bi bi-list-ul"></i></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="insertOrderedList" title="Numbered list"><i class="bi bi-list-ol"></i></button>
              </div>
              <div class="btn-group btn-group-sm me-1" role="group">
                <button type="button" class="btn btn-outline-secondary" data-cmd="formatBlock" data-value="h3" title="Heading">H3</button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="formatBlock" data-value="p" title="Paragraph">P</button>
              </div>
              <div class="btn-group btn-group-sm me-1" role="group">
                <button type="button" class="btn btn-outline-secondary" id="editLinkBtn" title="Insert link"><i class="bi bi-link-45deg"></i></button>
                <button type="button" class="btn btn-outline-secondary" data-cmd="removeFormat" title="Clear formatting"><i class="bi bi-eraser"></i></button>
              </div>
              <div class="btn-group btn-group-sm" role="group" aria-label="Table tools">
                <button type="button" class="btn btn-outline-secondary" id="etblInsert" title="Insert 3x3 table"><i class="bi bi-table"></i></button>
                <button type="button" class="btn btn-outline-secondary" id="etblAddRow" title="Add row below"><i class="bi bi-plus-lg"></i> Row</button>
                <button type="button" class="btn btn-outline-secondary" id="etblAddCol" title="Add column right"><i class="bi bi-plus-lg"></i> Col</button>
                <button type="button" class="btn btn-outline-secondary" id="etblDelRow" title="Delete row"><i class="bi bi-x-lg"></i> Row</button>
                <button type="button" class="btn btn-outline-secondary" id="etblDelCol" title="Delete column"><i class="bi bi-x-lg"></i> Col</button>
                <button type="button" class="btn btn-outline-secondary" id="etblDelTable" title="Delete table"><i class="bi bi-trash"></i></button>
              </div>
            </div>
            <div id="editEditorBody" class="form-control" contenteditable="true" style="min-height: 240px;">{{ doc.body|safe }}</div>
            <textarea name="body" id="editHiddenBody" class="d-none"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <div class="me-auto">
          <form id="deleteDocForm" method="post" action="{{ url_for('documents.delete', doc_id=doc.id) }}" onsubmit="return confirm('Delete this document? This cannot be undone.');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger">Delete</button>
          </form>
        </div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitEditDoc">Save</button>
      </div>
    </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Make all links in the rendered document body open in new tab
    try {
      document.querySelectorAll('.card .bg-body-tertiary a').forEach(a => {
        a.setAttribute('target','_blank');
        a.setAttribute('rel','noopener noreferrer');
      });
    } catch(e) {}
    const toolbar = document.querySelector('#editDocModal .btn-toolbar');
    const editor = document.getElementById('editEditorBody');
    const hidden = document.getElementById('editHiddenBody');
    const form = document.getElementById('editDocForm');
  const submitBtn = document.getElementById('submitEditDoc');
  const linkBtn = document.getElementById('editLinkBtn');
  // Table buttons
  const btnIns = document.getElementById('etblInsert');
  const btnAddRow = document.getElementById('etblAddRow');
  const btnAddCol = document.getElementById('etblAddCol');
  const btnDelRow = document.getElementById('etblDelRow');
  const btnDelCol = document.getElementById('etblDelCol');
  const btnDelTable = document.getElementById('etblDelTable');

    if (toolbar) {
      toolbar.addEventListener('click', function(e) {
        const btn = e.target.closest('button[data-cmd]');
        if (!btn) return;
        const cmd = btn.getAttribute('data-cmd');
        const val = btn.getAttribute('data-value');
        if (cmd === 'formatBlock') {
          document.execCommand(cmd, false, val || 'p');
        } else {
          document.execCommand(cmd, false, null);
        }
        editor.focus();
      });
    }
    if (linkBtn) {
      linkBtn.addEventListener('click', function() {
        let url = prompt('Enter URL (include http(s)://)');
        if (!url) return;
        try {
          if (!/^https?:\/\//i.test(url)) url = 'https://' + url;
        } catch(e) {}
        document.execCommand('createLink', false, url);
        // Ensure new link opens in new tab
        const sel = window.getSelection();
        if (sel && sel.anchorNode) {
          let node = sel.anchorNode.nodeType === 3 ? sel.anchorNode.parentElement : sel.anchorNode;
          while (node && node !== editor && node.tagName !== 'A') node = node.parentElement;
          if (node && node.tagName === 'A') {
            node.setAttribute('target','_blank');
            node.setAttribute('rel','noopener noreferrer');
          }
        }
        editor.focus();
      });
    }
    if (submitBtn && form && editor && hidden) {
      submitBtn.addEventListener('click', function() {
        hidden.value = editor.innerHTML;
        form.submit();
      });
    }
    // Helpers for table editing
    function closest(el, selector) {
      while (el && el.nodeType === 1) {
        if (el.matches(selector)) return el;
        el = el.parentElement;
      }
      return null;
    }
    function getSelectedCell() {
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return null;
      let node = sel.anchorNode;
      if (node && node.nodeType === 3) node = node.parentElement;
      return node ? closest(node, 'td,th') : null;
    }
    function insertTable(rows=3, cols=3) {
      let html = '<table class="table table-bordered table-sm"><tbody>';
      for (let r=0;r<rows;r++) {
        html += '<tr>';
        for (let c=0;c<cols;c++) html += '<td>&nbsp;</td>';
        html += '</tr>';
      }
      html += '</tbody></table>';
      document.execCommand('insertHTML', false, html);
      editor.focus();
    }
    function addRowBelow() {
      const cell = getSelectedCell();
      if (!cell) return;
      const tr = closest(cell, 'tr');
      const cols = tr ? tr.children.length : 0;
      const newTr = document.createElement('tr');
      for (let i=0;i<cols;i++) {
        const td = document.createElement('td');
        td.innerHTML = '&nbsp;';
        newTr.appendChild(td);
      }
      tr.parentElement.insertBefore(newTr, tr.nextSibling);
    }
    function addColRight() {
      const cell = getSelectedCell();
      if (!cell) return;
      const index = Array.from(cell.parentElement.children).indexOf(cell);
      const table = closest(cell, 'table');
      if (!table) return;
      table.querySelectorAll('tr').forEach(tr => {
        const td = document.createElement('td');
        td.innerHTML = '&nbsp;';
        if (index >= 0 && index < tr.children.length-1) {
          tr.insertBefore(td, tr.children[index+1]);
        } else {
          tr.appendChild(td);
        }
      });
    }
    function delRow() {
      const cell = getSelectedCell();
      if (!cell) return;
      const tr = closest(cell, 'tr');
      if (tr) tr.remove();
    }
    function delCol() {
      const cell = getSelectedCell();
      if (!cell) return;
      const index = Array.from(cell.parentElement.children).indexOf(cell);
      const table = closest(cell, 'table');
      if (!table) return;
      table.querySelectorAll('tr').forEach(tr => {
        if (index >=0 && index < tr.children.length) tr.children[index].remove();
      });
    }
    function delTable() {
      const cell = getSelectedCell();
      if (!cell) return;
      const table = closest(cell, 'table');
      if (table) table.remove();
    }
    if (btnIns) btnIns.addEventListener('click', () => insertTable());
    if (btnAddRow) btnAddRow.addEventListener('click', () => addRowBelow());
    if (btnAddCol) btnAddCol.addEventListener('click', () => addColRight());
    if (btnDelRow) btnDelRow.addEventListener('click', () => delRow());
    if (btnDelCol) btnDelCol.addEventListener('click', () => delCol());
    if (btnDelTable) btnDelTable.addEventListener('click', () => delTable());
  });
</script>
{% endblock %}

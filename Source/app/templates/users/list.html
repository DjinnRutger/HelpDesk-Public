{% extends 'base.html' %}
{% block title %}Users Â· HelpDesk{% endblock %}
{% block content %}
<!-- Users Header -->
<div class="card shadow-sm mb-3">
  <div class="card-header bg-body-tertiary">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="d-flex align-items-center">
        <i class="bi bi-people text-primary me-2 fs-4"></i>
        <div>
          <h1 class="h5 mb-0">Users</h1>
          <small class="text-muted">Manage user accounts and contacts</small>
        </div>
      </div>
      <div class="d-flex gap-2">
        <a href="{{ url_for('users.new_user') }}" class="btn btn-primary">
          <i class="bi bi-plus-lg me-1"></i>Add User
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Search & Filters -->
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="get" class="row g-3 align-items-end">
      <div class="col-md-7">
        <label class="form-label small fw-semibold"><i class="bi bi-search me-1"></i>Search Users</label>
        <input type="text" class="form-control" name="q" placeholder="Search by name or email..." value="{{ q or '' }}">
      </div>
      <div class="col-md-5">
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-outline-primary">
            <i class="bi bi-search me-1"></i>Search
          </button>
          {% if q %}
          <a href="{{ url_for('users.list_users', show_all='1' if show_all else '0') }}" class="btn btn-outline-secondary">
            <i class="bi bi-x-lg me-1"></i>Clear
          </a>
          {% endif %}
          <input type="hidden" name="show_all" value="{{ '1' if show_all else '0' }}">
          <a href="{{ url_for('users.list_users', q=q, show_all='0' if show_all else '1') }}" 
             class="btn btn-outline-secondary" 
             title="{{ 'Hide archived users' if show_all else 'Show all users including archived' }}">
            <i class="bi bi-eye{{ '' if show_all else '-slash' }}"></i>
          </a>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Results Summary -->
{% if contacts %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div class="text-muted small">
    <i class="bi bi-info-circle me-1"></i>
    {% if q %}
      Showing {{ contacts|length }} user{{ 's' if contacts|length != 1 else '' }} matching "{{ q }}"
    {% else %}
      Showing {{ contacts|length }} user{{ 's' if contacts|length != 1 else '' }} total
    {% endif %}
    {% if show_all %}
      <span class="badge bg-secondary ms-1">Including archived</span>
    {% endif %}
  </div>
</div>
{% endif %}

<!-- Users List -->
<div class="card shadow-sm">
  <div class="card-body p-0">
    {% if contacts %}
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th class="ps-3">
                <a href="{{ url_for('users.list_users', q=q, show_all='1' if show_all else '0', sort='name', order='desc' if sort == 'name' and order == 'asc' else 'asc') }}" class="text-decoration-none text-dark d-flex align-items-center">
                  User
                  {% if sort == 'name' %}
                    <i class="bi bi-caret-{{ 'down' if order == 'asc' else 'up' }}-fill ms-1 text-primary"></i>
                  {% else %}
                    <i class="bi bi-caret-down ms-1 text-muted opacity-25"></i>
                  {% endif %}
                </a>
              </th>
              <th>
                <a href="{{ url_for('users.list_users', q=q, show_all='1' if show_all else '0', sort='email', order='desc' if sort == 'email' and order == 'asc' else 'asc') }}" class="text-decoration-none text-dark d-flex align-items-center">
                  Email
                  {% if sort == 'email' %}
                    <i class="bi bi-caret-{{ 'down' if order == 'asc' else 'up' }}-fill ms-1 text-primary"></i>
                  {% else %}
                    <i class="bi bi-caret-down ms-1 text-muted opacity-25"></i>
                  {% endif %}
                </a>
              </th>
              <th>
                <a href="{{ url_for('users.list_users', q=q, show_all='1' if show_all else '0', sort='password', order='desc' if sort == 'password' and order == 'asc' else 'asc') }}" class="text-decoration-none text-dark d-flex align-items-center">
                  Password Expires
                  {% if sort == 'password' %}
                    <i class="bi bi-caret-{{ 'down' if order == 'asc' else 'up' }}-fill ms-1 text-primary"></i>
                  {% else %}
                    <i class="bi bi-caret-down ms-1 text-muted opacity-25"></i>
                  {% endif %}
                </a>
              </th>
            </tr>
          </thead>
          <tbody>
            {% for c in contacts %}
            <tr class="user-row{{ ' table-secondary' if c.archived else '' }}" data-href="{{ url_for('users.show_user', contact_id=c.id) }}" tabindex="0" role="button">
              <td class="ps-3">
                <div class="d-flex align-items-center">
                  <i class="bi bi-person-circle text-muted me-2 fs-5"></i>
                  <div>
                    <div class="fw-semibold">
                      {{ c.name or 'Unnamed User' }}
                      {% if c.archived %}
                        <span class="badge bg-secondary ms-1">Archived</span>
                      {% endif %}
                    </div>
                    {% if c.notes %}
                      <div class="small text-muted text-truncate" style="max-width: 200px;" title="{{ c.notes }}">{{ c.notes }}</div>
                    {% endif %}
                  </div>
                </div>
              </td>
              <td class="align-middle">
                <div class="d-flex align-items-center">
                  <i class="bi bi-envelope text-muted me-1"></i>
                  <span class="text-break">{{ c.email }}</span>
                </div>
              </td>
              <td class="align-middle">
                {% if c.ad_disabled %}
                  <span class="badge bg-danger"><i class="bi bi-person-slash me-1"></i>Disabled</span>
                {% elif c.password_expires_days is none %}
                  <span class="text-muted small"><i class="bi bi-question-circle me-1"></i>Not checked</span>
                {% elif c.password_expires_days == -1 %}
                  <span class="badge bg-info"><i class="bi bi-infinity me-1"></i>Never expires</span>
                {% elif c.password_expires_days == -999 %}
                  <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Not in AD</span>
                {% elif c.password_expires_days < 0 %}
                  <span class="badge bg-danger"><i class="bi bi-exclamation-triangle me-1"></i>Expired</span>
                {% elif c.password_expires_days <= 14 %}
                  <span class="badge bg-warning text-dark"><i class="bi bi-clock me-1"></i>{{ c.password_expires_days }} days</span>
                {% else %}
                  <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>{{ c.password_expires_days }} days</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-center py-5">
        <i class="bi bi-people display-1 text-muted opacity-25"></i>
        <h5 class="mt-3 mb-2">No Users Found</h5>
        {% if q %}
          <p class="text-muted mb-3">No users match your search criteria.</p>
          <a href="{{ url_for('users.list_users') }}" class="btn btn-outline-secondary">View All Users</a>
        {% else %}
          <p class="text-muted mb-3">Get started by adding your first user.</p>
          <a href="{{ url_for('users.new_user') }}" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i>Add User
          </a>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const rows = document.querySelectorAll('tr.user-row[data-href]');
  rows.forEach(row => {
    row.style.cursor = 'pointer';
    row.addEventListener('click', () => {
      const url = row.getAttribute('data-href');
      if (url) window.location = url;
    });
    row.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        row.click();
      }
    });
  });
  // Prevent row navigation when clicking external link buttons
  document.querySelectorAll('.user-row a').forEach(a => {
    a.addEventListener('click', e => e.stopPropagation());
  });
});
</script>
{% endblock %}

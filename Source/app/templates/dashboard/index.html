{% extends 'base.html' %}
{% block title %}Dashboard · HelpDesk{% endblock %}
{% block head %}
<script>
  // Reload every 30s, only if tab is visible
  setInterval(function(){
    if (document.visibilityState === 'visible') {
      location.reload();
    }
  }, 30000);
</script>
{% endblock %}
{% block content %}
<!-- Dashboard Header -->
<div class="card shadow-sm mb-3">
  <div class="card-header bg-body-tertiary">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="d-flex align-items-center">
        <i class="bi bi-speedometer2 text-primary me-2 fs-4"></i>
        <div>
          <h1 class="h5 mb-0">Dashboard</h1>
          <small class="text-muted">System overview and recent activity</small>
        </div>
      </div>
      <div class="d-flex gap-2">
        <a href="{{ url_for('tickets.list_tickets', status='open') }}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-list me-1"></i>All Open Tickets
        </a>
        <a href="{{ url_for('dashboard.index', show_snoozed=(0 if show_snoozed else 1)) }}" class="btn btn-outline-secondary btn-sm" title="Toggle snoozed">
          <i class="bi bi-moon"></i>
          {% if stats.snoozed_count %}
            <span class="badge rounded-pill text-bg-secondary ms-1">{{ stats.snoozed_count }}</span>
          {% endif %}
        </a>
        <a href="{{ url_for('tickets.new_ticket') }}" class="btn btn-primary btn-sm">
          <i class="bi bi-plus-lg me-1"></i>New Ticket
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Statistics Cards -->
<div class="row g-3 mb-3">
  <!-- Health Widget -->
  <div class="col-md-3">
    <div class="card shadow-sm h-100" style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#healthModal">
      <div class="card-body text-center">
        <i class="bi bi-heart-pulse text-{{ stats.health_class }} fs-1 mb-2"></i>
        <div class="h2 mb-1" style="color: {{ stats.health_color }};">{{ stats.health }}</div>
        <div class="text-muted small">Health <i class="bi bi-info-circle"></i></div>
      </div>
    </div>
  </div>
  <!-- Total Open Tickets Widget -->
  <div class="col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-body text-center">
        <i class="bi bi-ticket-perforated text-primary fs-1 mb-2"></i>
        <div class="h2 mb-1">{{ stats.open_total }}</div>
        <div class="text-muted small">Total Open Tickets</div>
      </div>
    </div>
  </div>
  <!-- Leaders Widget -->
  <div class="col-md-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="text-center mb-2">
          <i class="bi bi-trophy text-warning fs-1"></i>
          <div class="text-muted small mt-1">Leaders (This Week)</div>
        </div>
        <div class="small">
          {% if stats.leaders %}
            {% for leader in stats.leaders %}
              {% set first_name = leader.name.split(' ')[0] if leader.name else 'Unknown' %}
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="text-truncate" style="max-width: 140px;">{{ first_name }}</span>
                <span class="badge text-bg-success">{{ leader.closed_count }}</span>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-center text-muted fst-italic">No data yet</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <!-- Ticket Sources Pie Chart Widget -->
  <div class="col-md-3">
    <div class="card shadow-sm h-100" id="sourceChartCard" style="cursor:pointer;" title="Click to change time range">
      <div class="card-body d-flex flex-column align-items-center p-2">
        <div class="text-muted small mb-1" id="sourceChartLabel">Sources (30 days)</div>
        <canvas id="sourceChart" style="max-height:140px;"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Recent Open Tickets -->
<div class="card shadow-sm">
  <div class="card-header bg-body-tertiary">
    <div class="d-flex align-items-center justify-content-between">
      <h6 class="mb-0"><i class="bi bi-list-task me-1"></i>Recent Open Tickets</h6>
      <a href="{{ url_for('tickets.list_tickets', status='open') }}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-right me-1"></i>View All Open
      </a>
    </div>
  </div>
  <div class="card-body p-0">
    {% if tickets %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="border-0">Ticket</th>
              <th class="border-0">Requester</th>
              <th class="border-0">Assignee</th>
              <th class="border-0">Status</th>
              <th class="border-0">Priority</th>
              <th class="border-0">Age</th>
              <th class="border-0"></th>
            </tr>
          </thead>
          <tbody>
            {% for t in tickets %}
              <tr class="clickable-row {% if t.priority == 'high' %}table-danger{% endif %}" data-href="{{ url_for('tickets.show_ticket', ticket_id=t.id) }}">
                <td>
                  <div class="fw-semibold">#{{ t.id }}</div>
                  <div class="text-muted small text-truncate" style="max-width: 250px;">{{ t.subject }}
                    {% if show_snoozed and t.is_snoozed %}
                      <span class="ms-1"><i class="bi bi-moon"></i> {{ t.snoozed_until|cst_datetime('%m/%d/%Y') }}</span>
                    {% endif %}
                  </div>
                </td>
                <td class="small">{{ t.requester_name or t.requester_email or '—' }}</td>
                <td class="small">{{ t.assignee.name if t.assignee else '—' }}</td>
                <td>
                  <span class="badge text-bg-{{ t.status|status_color }}">{{ t.status|status_label }}</span>
                </td>
                <td>
                  {% if t.priority == 'high' %}
                    <span class="badge text-bg-danger">High</span>
                  {% elif t.priority == 'medium' %}
                    <span class="badge text-bg-warning">Medium</span>
                  {% else %}
                    <span class="badge text-bg-secondary">Low</span>
                  {% endif %}
                </td>
                <td class="small">{{ t.age_days }}d</td>
                <td>
                  <i class="bi bi-chevron-right text-muted"></i>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-center py-5">
        <i class="bi bi-check-circle display-1 text-success opacity-25"></i>
        <h5 class="mt-3 mb-2">All Caught Up!</h5>
        <p class="text-muted mb-3">No open tickets at this time.</p>
        <a href="{{ url_for('tickets.new_ticket') }}" class="btn btn-primary">
          <i class="bi bi-plus-lg me-1"></i>Create New Ticket
        </a>
      </div>
    {% endif %}
  </div>
</div>
<!-- Health Breakdown Modal -->
<div class="modal fade" id="healthModal" tabindex="-1" aria-labelledby="healthModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="healthModalLabel"><i class="bi bi-heart-pulse me-2"></i>Health Score Breakdown</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <span class="display-4 fw-bold" style="color: {{ stats.health_color }};">{{ stats.health }}</span>
          <span class="text-muted">/ 100</span>
        </div>
        <table class="table table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th>Factor</th>
              <th class="text-center">Count</th>
              <th class="text-end">Impact</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="3" class="text-muted small fw-semibold pt-3">Starting Score</td>
            </tr>
            <tr>
              <td>Base Score</td>
              <td class="text-center">—</td>
              <td class="text-end text-success fw-semibold">100</td>
            </tr>
            <tr>
              <td colspan="3" class="text-muted small fw-semibold pt-3">Penalties</td>
            </tr>
            <tr>
              <td><i class="bi bi-exclamation-triangle text-danger me-1"></i>Overdue High-Priority <span class="text-muted small">(×10)</span></td>
              <td class="text-center">{{ stats.health_breakdown.overdue_count }}</td>
              <td class="text-end text-danger fw-semibold">{% if stats.health_breakdown.overdue_penalty %}&minus;{{ stats.health_breakdown.overdue_penalty }}{% else %}0{% endif %}</td>
            </tr>
            <tr>
              <td><i class="bi bi-person-x text-warning me-1"></i>Unassigned &gt; 24h <span class="text-muted small">(×5)</span></td>
              <td class="text-center">{{ stats.health_breakdown.unassigned_24h }}</td>
              <td class="text-end text-danger fw-semibold">{% if stats.health_breakdown.unassigned_penalty %}&minus;{{ stats.health_breakdown.unassigned_penalty }}{% else %}0{% endif %}</td>
            </tr>
            <tr>
              <td><i class="bi bi-clock text-info me-1"></i>Open &gt; 7 days <span class="text-muted small">(×2)</span></td>
              <td class="text-center">{{ stats.health_breakdown.open_7days }}</td>
              <td class="text-end text-danger fw-semibold">{% if stats.health_breakdown.open_7days_penalty %}&minus;{{ stats.health_breakdown.open_7days_penalty }}{% else %}0{% endif %}</td>
            </tr>
            <tr>
              <td><i class="bi bi-clock-history text-danger me-1"></i>Open &gt; 14 days <span class="text-muted small">(×4)</span></td>
              <td class="text-center">{{ stats.health_breakdown.open_14days }}</td>
              <td class="text-end text-danger fw-semibold">{% if stats.health_breakdown.open_14days_penalty %}&minus;{{ stats.health_breakdown.open_14days_penalty }}{% else %}0{% endif %}</td>
            </tr>
            <tr>
              <td colspan="3" class="text-muted small fw-semibold pt-3">Bonuses</td>
            </tr>
            <tr>
              <td><i class="bi bi-check-circle text-success me-1"></i>Closed Today <span class="text-muted small">(×3)</span></td>
              <td class="text-center">{{ stats.health_breakdown.closed_today }}</td>
              <td class="text-end text-success fw-semibold">{% if stats.health_breakdown.closed_today_bonus %}+{{ stats.health_breakdown.closed_today_bonus }}{% else %}0{% endif %}</td>
            </tr>
          </tbody>
          <tfoot class="table-light">
            <tr class="fw-bold">
              <td>Final Score <span class="text-muted small fw-normal">(clamped 0–100)</span></td>
              <td></td>
              <td class="text-end" style="color: {{ stats.health_color }};">{{ stats.health }}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script>
(function() {
  const PERIODS = [
    { days: 7,  label: 'Sources (1 week)' },
    { days: 30, label: 'Sources (30 days)' },
    { days: 60, label: 'Sources (60 days)' },
    { days: 90, label: 'Sources (90 days)' },
  ];
  let periodIdx = 1; // default 30 days
  const COLORS = [
    '#0d6efd','#6610f2','#6f42c1','#d63384','#dc3545',
    '#fd7e14','#ffc107','#198754','#20c997','#0dcaf0'
  ];

  const ctx = document.getElementById('sourceChart').getContext('2d');
  let chart = new Chart(ctx, {
    type: 'pie',
    data: { labels: [], datasets: [{ data: [], backgroundColor: COLORS }] },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } },
        tooltip: {
          callbacks: {
            label: function(c) {
              const total = c.dataset.data.reduce((a, b) => a + b, 0);
              const pct = total ? Math.round(c.raw / total * 100) : 0;
              return c.label + ': ' + c.raw + ' (' + pct + '%)';
            }
          }
        }
      }
    }
  });

  function load(days, label) {
    fetch('{{ url_for("dashboard.ticket_sources") }}?days=' + days)
      .then(r => r.json())
      .then(d => {
        chart.data.labels = d.labels;
        chart.data.datasets[0].data = d.counts;
        chart.update();
        document.getElementById('sourceChartLabel').textContent = label;
      });
  }

  // Initial load
  load(PERIODS[periodIdx].days, PERIODS[periodIdx].label);

  // Click to cycle
  document.getElementById('sourceChartCard').addEventListener('click', function() {
    periodIdx = (periodIdx + 1) % PERIODS.length;
    load(PERIODS[periodIdx].days, PERIODS[periodIdx].label);
  });
})();
</script>
{% endblock %}

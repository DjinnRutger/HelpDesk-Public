{% extends 'base.html' %}
{% block title %}{{ action }} Scheduled Ticket Â· Admin{% endblock %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-header bg-body-tertiary">
    <h1 class="h5 mb-0">{{ action }} Scheduled Ticket</h1>
  </div>
  <div class="card-body">
    <form method="post">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Name</label>
          <input name="name" class="form-control" value="{{ row.name if row else '' }}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Assignee</label>
          <select name="assignee_id" class="form-select">
            <option value="">Unassigned</option>
            {% for u in techs %}
              <option value="{{ u.id }}" {% if row and row.assignee_id == u.id %}selected{% endif %}>{{ u.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-8">
          <label class="form-label">Subject</label>
          <input name="subject" class="form-control" value="{{ row.subject if row else '' }}" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Priority</label>
          <select name="priority" class="form-select">
            {% for p in ['low','medium','high'] %}
              <option value="{{ p }}" {% if row and row.priority==p %}selected{% endif %}>{{ p|title }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">Body (optional)</label>
          <textarea name="body" class="form-control" rows="4">{{ row.body if row else '' }}</textarea>
        </div>
        <div class="col-12">
          <label class="form-label">Tasks (one per line)</label>
          <textarea name="tasks_text" class="form-control" rows="4" placeholder="Task 1\nTask 2">{{ row.tasks_text if row else '' }}</textarea>
        </div>
        <div class="col-md-3">
          <label class="form-label">Default Status</label>
          <select name="status" class="form-select">
            {% for s in ['open','in_progress','closed'] %}
              <option value="{{ s }}" {% if row and row.status==s %}selected{% endif %}>{{ s|replace('_',' ')|title }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Schedule</label>
          <select name="schedule_type" class="form-select" id="schedType">
            {% for s in ['daily','weekly','monthly'] %}
              <option value="{{ s }}" {% if row and row.schedule_type==s %}selected{% endif %}>{{ s|title }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3" id="dowWrap">
          <label class="form-label">Day of Week</label>
          <select name="day_of_week" class="form-select">
            {% for i, d in [(0,'Mon'),(1,'Tue'),(2,'Wed'),(3,'Thu'),(4,'Fri'),(5,'Sat'),(6,'Sun')] %}
              <option value="{{ i }}" {% if row and row.day_of_week==i %}selected{% endif %}>{{ d }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3" id="domWrap">
          <label class="form-label">Day of Month</label>
          <input type="number" name="day_of_month" min="1" max="31" class="form-control" value="{{ row.day_of_month if row else '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Time (HH:MM)</label>
          <input type="time" name="schedule_time" class="form-control" value="{{ row.schedule_time if row and row.schedule_time else '00:00' }}">
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="active" id="activeChk" {% if row and row.active %}checked{% endif %}>
            <label class="form-check-label" for="activeChk">Active</label>
          </div>
        </div>
      </div>
      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-primary">Save</button>
        <a class="btn btn-outline-secondary" href="{{ url_for('admin.scheduled_list') }}">Cancel</a>
      </div>
    </form>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  function updateVisibility(){
    const type = document.getElementById('schedType').value;
    document.getElementById('dowWrap').style.display = (type==='weekly') ? '' : 'none';
    document.getElementById('domWrap').style.display = (type==='monthly') ? '' : 'none';
  }
  document.getElementById('schedType').addEventListener('change', updateVisibility);
  updateVisibility();
</script>
{% endblock %}

{% extends 'base.html' %}
{% block title %}Orders · HelpDesk{% endblock %}
{% block content %}
<!-- Orders Header -->
<div class="card shadow-sm mb-3">
  <div class="card-header bg-body-tertiary">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="d-flex align-items-center">
        <i class="bi bi-cart3 text-primary me-2 fs-4"></i>
        <div>
          <h1 class="h5 mb-0">Orders & Purchasing</h1>
          <small class="text-muted">Manage purchase orders and procurement</small>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Search Section -->
<div class="card shadow-sm mb-3">
  <div class="card-header bg-body-tertiary">
    <h6 class="mb-0"><i class="bi bi-search me-1"></i>Search Purchase Orders</h6>
  </div>
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-8">
        <input type="text" name="search" value="{{ search_query or '' }}" class="form-control" 
               placeholder="Search by vendor, PO number, line items, notes..." autocomplete="off">
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100"><i class="bi bi-search me-1"></i>Search</button>
      </div>
      <div class="col-md-2">
        {% if search_query %}
        <a href="{{ url_for('orders.list_items') }}" class="btn btn-outline-secondary w-100"><i class="bi bi-x-circle me-1"></i>Clear</a>
        {% endif %}
      </div>
    </form>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-8">
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-body-tertiary">
        <div class="d-flex align-items-center justify-content-between">
          <h6 class="mb-0"><i class="bi bi-list-check me-1"></i>Planned Items</h6>
          <span class="badge text-bg-secondary">{{ planned|length }} item{{ 's' if planned|length != 1 else '' }}</span>
        </div>
      </div>
      <!-- Form now properly wraps table and footer (was previously broken by markup) -->
      <form method="post" action="{{ url_for('orders.create_po_from_items') }}" id="poBuildForm" class="mb-0">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="card-body p-0">
        {% if planned %}
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th class="border-0" style="width:26px;"><input type="checkbox" id="checkAllPlanned"></th>
                  <th class="border-0">Description</th>
                  <th class="border-0">Qty</th>
                  <th class="border-0">Vendor</th>
                  <th class="border-0">Est Cost</th>
                  <th class="border-0">Dept/CC</th>
                  <th class="border-0">Needed By</th>
                  <th class="border-0">Ticket</th>
                  <th class="border-0">Status</th>
                </tr>
              </thead>
              <tbody>
                {% for it in planned %}
                <tr>
                  <td><input type="checkbox" name="item_id" value="{{ it.id }}" class="planned-item-chk form-check-input"></td>
                  <td>
                    <div class="d-flex align-items-center" style="max-width: 280px;">
                      <span class="fw-semibold text-truncate me-1" style="min-width: 0;" title="{{ it.description }}">{{ it.description }}</span>
                      {% if it.source_url %}
                        <a href="{{ it.source_url }}" target="_blank" rel="noopener" class="text-muted flex-shrink-0" title="Open source link">
                          <i class="bi bi-link-45deg"></i>
                        </a>
                      {% endif %}
                    </div>
                  </td>
                  <td class="small">{{ it.quantity }}</td>
                  <td class="small">{{ it.target_vendor or '—' }}</td>
                  <td class="small">{% if it.est_unit_cost %}${{ '%.2f'|format(it.est_unit_cost) }}{% else %}—{% endif %}</td>
                  <td class="small">{{ it.dept_code or '—' }}</td>
                  <td class="small">{{ it.needed_by_text or '—' }}</td>
                  <td class="small">{% if it.ticket_id %}<a href="{{ url_for('tickets.show_ticket', ticket_id=it.ticket_id) }}" class="text-decoration-none">#{{ it.ticket_id }}</a>{% else %}—{% endif %}</td>
                  <td><span class="badge text-bg-secondary">{{ it.status }}</span></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-center py-5">
            <i class="bi bi-list-check display-1 text-muted opacity-25"></i>
            <h5 class="mt-3 mb-2">No Planned Items</h5>
            <p class="text-muted mb-3">Add items below to start planning your purchase orders.</p>
          </div>
        {% endif %}
        </div><!-- /card-body -->
        {% if planned %}
        <div class="card-footer bg-body-tertiary">
          <div class="row g-2 align-items-end">
            <div class="col-md-5">
              <label class="form-label small fw-semibold">Vendor</label>
              <select name="vendor" class="form-select" required id="vendorSelect">
                <option value="">Select vendor…</option>
                {% for v in (vendors or []) %}
                <option value="{{ v.company_name }}">{{ v.company_name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <button class="btn btn-primary w-100" id="createPOBtn" disabled><i class="bi bi-plus-lg me-1"></i>Create Order</button>
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-outline-danger w-100" id="deleteSelectedBtn" disabled onclick="confirmDelete()"><i class="bi bi-trash me-1"></i>Delete Selected</button>
            </div>
            <div class="col-md-2">
              <small class="text-muted">Select items to include in a new Purchase Order or delete.</small>
            </div>
          </div>
        </div>
        {% endif %}
      </form>
        <script>
          (function(){
            const form = document.getElementById('poBuildForm');
            if(!form) return;
            const all = form.querySelector('#checkAllPlanned');
            const createBtn = form.querySelector('#createPOBtn');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const vendorSelect = form.querySelector('#vendorSelect');
            const chks = form.querySelectorAll('.planned-item-chk');
            function updateBtns(){
              const any = Array.from(chks).some(c=>c.checked);
              const hasVendor = vendorSelect && vendorSelect.value.trim() !== '';
              if(createBtn) createBtn.disabled = !(any && hasVendor);
              if(deleteBtn) deleteBtn.disabled = !any; // delete only needs selection
            }
            if(all){
              all.addEventListener('change', ()=>{
                chks.forEach(c=> c.checked = all.checked);
                updateBtns();
              });
            }
            chks.forEach(c=> c.addEventListener('change', updateBtns));
            if(vendorSelect) vendorSelect.addEventListener('change', updateBtns);
            updateBtns();
          })();
          
          function confirmDelete() {
            const chks = document.querySelectorAll('.planned-item-chk:checked');
            const count = chks.length;
            if (count === 0) return;
            const message = `Are you sure you want to delete ${count} selected item${count > 1 ? 's' : ''}? This action cannot be undone.`;
            if (confirm(message)) {
              const itemIds = Array.from(chks).map(c => c.value);
              deleteItems(itemIds);
            }
          }
          
          function deleteItems(itemIds) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("orders.delete_selected_items") }}';
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = '{{ csrf_token() }}';
            form.appendChild(csrfInput);
            itemIds.forEach(id => {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = 'item_ids';
              input.value = id;
              form.appendChild(input);
            });
            document.body.appendChild(form);
            form.submit();
          }
        </script>
        <!-- Add Planned Item (now directly under Planned Items in left column) -->
        <div class="card shadow-sm mt-3">
          <div class="card-header bg-body-tertiary">
            <h6 class="mb-0"><i class="bi bi-plus-circle me-1"></i>Add Planned Item</h6>
          </div>
          <div class="card-body">
            <form method="post" action="{{ url_for('orders.create_item') }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <div class="mb-3">
                <label class="form-label small fw-semibold">Description</label>
                <input name="description" class="form-control" placeholder="Item description" required>
              </div>
              <div class="row g-3 mb-3">
                <div class="col-4">
                  <label class="form-label small fw-semibold">Quantity</label>
                  <input name="quantity" type="number" min="1" value="1" class="form-control" placeholder="Qty">
                </div>
                <div class="col-8">
                  <label class="form-label small fw-semibold">Vendor</label>
                  <input name="target_vendor" class="form-control" placeholder="Target vendor">
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label small fw-semibold">Estimated Unit Cost</label>
                <input name="est_unit_cost" class="form-control" placeholder="0.00">
              </div>
              <div class="row g-3 mb-3">
                <div class="col-6">
                  <label class="form-label small fw-semibold">Dept/Cost Code</label>
                  <input name="dept_code" class="form-control" placeholder="Optional">
                </div>
                <div class="col-6">
                  <label class="form-label small fw-semibold">Needed By</label>
                  <input type="date" name="needed_by" class="form-control">
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label small fw-semibold">Source URL</label>
                <input name="source_url" class="form-control" placeholder="Product or vendor URL">
              </div>
              <button class="btn btn-primary w-100"><i class="bi bi-plus-lg me-1"></i>Add Item</button>
            </form>
          </div>
        </div>
    </div>
    </div><!-- /col -->
  <div class="col-lg-4">
    <!-- Purchase Orders List -->
    <div class="card shadow-sm">
      <div class="card-header bg-body-tertiary">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0 d-flex align-items-center gap-2">
            <i class="bi bi-receipt me-1"></i>
            {% if is_search_results %}
              Search Results
              {% if search_query %}
                <small class="text-muted">for "{{ search_query }}"</small>
              {% endif %}
            {% else %}
              Recent Purchase Orders
            {% endif %}
          </h6>
          <div class="d-flex align-items-center gap-2">
            {% if not is_search_results %}
            <a
              class="btn btn-sm btn-outline-secondary"
              title="{{ 'Show completed' if not show_completed else 'Hide completed' }}"
              href="{{ url_for('orders.list_items', page=1, per_page=per_page, search=search_query if search_query else none, show_completed=(not show_completed)) }}"
            >
              {% if show_completed %}
                <i class="bi bi-eye-slash"></i>
              {% else %}
                <i class="bi bi-eye"></i>
              {% endif %}
            </a>
            {% endif %}
            <span class="badge bg-primary">{{ pagination.total if pagination else 0 }}</span>
            {% if not show_all %}
            <div class="btn-group btn-group-sm" role="group">
              <a href="{{ url_for('orders.list_items', per_page=5, page=1, search=search_query if search_query else none, show_completed=show_completed) }}" 
                class="btn btn-outline-secondary {{ 'active' if per_page == 5 else '' }}">5</a>
              <a href="{{ url_for('orders.list_items', per_page=20, page=1, search=search_query if search_query else none, show_completed=show_completed) }}" 
                class="btn btn-outline-secondary {{ 'active' if per_page == 20 else '' }}">20</a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        {% if pos %}
        <div class="list-group list-group-flush">
          {% for po in pos %}
          <div class="list-group-item clickable-row" data-href="{{ url_for('orders.show_po', po_id=po.id) }}">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-1">
                  <a 
                    href="{{ url_for('orders.show_po', po_id=po.id) }}"
                    class="fw-semibold text-decoration-none"
                    title="View Purchase Order"
                    onclick="event.stopPropagation();"
                  >#{{ po.po_number or 'Draft-' ~ po.id }}</a>
                  {# Map status to badge colors; statuses are lowercase in model defaults #}
                  {% set st = (po.status or '').lower() %}
                  {% set badge = 'secondary' %}
                  {% if st in ['complete', 'received'] %}
                    {% set badge = 'success' %}
                  {% elif st in ['sent', 'open', 'partially_received', 'ordered'] %}
                    {% set badge = 'warning' %}
                  {% elif st in ['draft'] %}
                    {% set badge = 'secondary' %}
                  {% elif st in ['canceled', 'cancelled'] %}
                    {% set badge = 'danger' %}
                  {% endif %}
                  <span class="badge bg-{{ badge }} ms-2">{{ po.status }}</span>
                </div>
                <div class="text-dark small">{{ po.vendor_name }}</div>
                <div class="text-muted small">
                  <i class="bi bi-calendar3 me-1"></i>
                  {% if po.ordered_at %}
                    Ordered {{ po.ordered_at.strftime('%m/%d/%Y') }}
                  {% else %}
                    Created {{ po.created_at.strftime('%m/%d/%Y') }}
                  {% endif %}
                </div>
                <div class="text-muted small">
                  <i class="bi bi-currency-dollar me-1"></i>${{ '%.2f'|format(po.total_subtotal) }}
                  {% if po.items|length > 0 %}
                  <span class="ms-2"><i class="bi bi-box me-1"></i>{{ po.items|length }} item{{ 's' if po.items|length != 1 else '' }}</span>
                  {% endif %}
                </div>
                {% if is_search_results and po.notes and search_query.lower() in po.notes.lower() %}
                <div class="text-muted small mt-1">
                  <i class="bi bi-chat-left-text me-1"></i>{{ po.notes[:100] }}{% if po.notes|length > 100 %}...{% endif %}
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-4">
          <i class="bi bi-receipt text-muted" style="font-size: 2rem;"></i>
          <p class="text-muted mt-2 mb-0">
            {% if is_search_results %}
              No purchase orders match your search
            {% else %}
              No purchase orders yet
            {% endif %}
          </p>
        </div>
        {% endif %}
      </div>
      
      <!-- Pagination Controls -->
      {% if pagination and pagination.pages > 1 %}
      <div class="card-footer bg-body-tertiary">
        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted">
            Showing {{ pagination.per_page * (pagination.page - 1) + 1 }} - 
            {{ pagination.per_page * (pagination.page - 1) + pos|length }} of {{ pagination.total }}
          </small>
          <nav aria-label="Purchase orders pagination">
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item {{ 'disabled' if not pagination.has_prev else '' }}">
                {% if pagination.has_prev %}
                  <a class="page-link" href="{{ url_for('orders.list_items', page=pagination.prev_num, per_page=per_page, search=search_query if search_query else none, show_completed=show_completed) }}">
                    <i class="bi bi-chevron-left"></i>
                  </a>
                {% else %}
                  <span class="page-link"><i class="bi bi-chevron-left"></i></span>
                {% endif %}
              </li>
              
              {% for page_num in pagination.iter_pages() %}
                {% if page_num %}
                  {% if page_num != pagination.page %}
                    <li class="page-item">
                      <a class="page-link" href="{{ url_for('orders.list_items', page=page_num, per_page=per_page, search=search_query if search_query else none, show_completed=show_completed) }}">{{ page_num }}</a>
                    </li>
                  {% else %}
                    <li class="page-item active">
                      <span class="page-link">{{ page_num }}</span>
                    </li>
                  {% endif %}
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link">…</span>
                  </li>
                {% endif %}
              {% endfor %}
              
              <li class="page-item {{ 'disabled' if not pagination.has_next else '' }}">
                {% if pagination.has_next %}
                  <a class="page-link" href="{{ url_for('orders.list_items', page=pagination.next_num, per_page=per_page, search=search_query if search_query else none, show_completed=show_completed) }}">
                    <i class="bi bi-chevron-right"></i>
                  </a>
                {% else %}
                  <span class="page-link"><i class="bi bi-chevron-right"></i></span>
                {% endif %}
              </li>
            </ul>
          </nav>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Make rows clickable
document.addEventListener('DOMContentLoaded', function() {
    const clickableRows = document.querySelectorAll('.clickable-row');
    clickableRows.forEach(row => {
        row.style.cursor = 'pointer';
        row.addEventListener('click', function() {
            const href = this.getAttribute('data-href');
            if (href) {
                window.location.href = href;
            }
        });
    });
});
</script>
{% endblock %}
